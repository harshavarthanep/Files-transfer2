<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfinityDrop | MQTT Tunnel</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        /* Keeping your original beautiful styling */
        :root { --bg: #050505; --surface: #111; --border: #333; --primary: #fff; --success: #22c55e; --text-sec: #666; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--primary); min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .app-container { width: 100%; max-width: 440px; display: flex; flex-direction: column; gap: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .status-dot { width: 8px; height: 8px; background: #333; border-radius: 50%; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 8px rgba(34, 197, 94, 0.3); }
        .panel { display: flex; flex-direction: column; gap: 16px; }
        .input-row { display: flex; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 4px; }
        input[type="text"] { flex: 1; background: transparent; border: none; color: white; padding: 12px; outline: none; font-family: 'JetBrains Mono', monospace; }
        .btn-main { width: 100%; padding: 14px; background: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition:0.2s; }
        .btn-main:hover { opacity:0.9; }
        .hidden { display: none !important; }
        .log-box { background: #080808; border-top: 1px solid var(--border); padding: 10px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: #555; height: 120px; overflow-y: auto; }
        .file-item { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-top: 10px; }
        .progress-bar { height: 4px; background: #222; margin-top: 8px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: white; transition: width 0.1s; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>InfinityDrop <span style="font-size:0.6em; opacity:0.5; border:1px solid #333; padding:2px 6px; border-radius:4px;">TUNNEL</span></h1>
        <div class="status-badge" style="display:flex; gap:6px; align-items:center; font-size:0.75rem; color:#666;">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">Connecting...</span>
        </div>
    </header>

    <div id="panel-connect" class="panel">
        <div>
            <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px;">YOUR ID</div>
            <div class="input-row">
                <input type="text" id="my-id" readonly value="...">
            </div>
        </div>

        <div>
            <div style="font-size: 0.7rem; color: #666; margin-bottom: 6px;">PARTNER ID</div>
            <div class="input-row">
                <input type="text" id="partner-id" placeholder="Enter ID to connect">
            </div>
        </div>
        <button id="btn-connect" class="btn-main" onclick="connectToPartner()">Connect</button>
    </div>

    <div id="panel-transfer" class="panel hidden">
        <div style="border: 1px dashed #333; padding: 40px; text-align: center; border-radius: 12px; cursor: pointer; position: relative;">
            <input type="file" id="file-input" multiple style="position:absolute; inset:0; opacity:0; cursor:pointer;">
            <div style="margin-bottom:5px;">+ Send Files</div>
            <div style="font-size:0.75rem; color:#666">Max recommended: 50MB</div>
        </div>
        <div id="file-queue"></div>
        <button class="btn-main" onclick="location.reload()" style="background:transparent; border:1px solid #333; color:#888;">Disconnect</button>
    </div>

    <div id="logs" class="log-box"></div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    // We use a public, free broker. 
    // Options: 'broker.emqx.io', 'test.mosquitto.org', 'broker.hivemq.com'
    const BROKER_URL = 'wss://broker.emqx.io:8084/mqtt'; 
    const CHUNK_SIZE = 12 * 1024; // 12KB chunks (Safe for MQTT)

    // --- 2. UTILS ---
    const log = (msg) => {
        const box = document.getElementById('logs');
        box.innerHTML += `<div>> ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    };
    const generateId = () => Math.random().toString(36).substr(2, 6).toUpperCase();
    const formatSize = (b) => (b/1024/1024).toFixed(2) + ' MB';

    // --- 3. STATE ---
    let client;
    let myId = generateId();
    let partnerId = null;
    let fileRegistry = {};
    let isConnected = false;

    document.getElementById('my-id').value = myId;

    // --- 4. MQTT CONNECTION ---
    log(`Connecting to Public Relay...`);
    
    client = mqtt.connect(BROKER_URL, {
        keepalive: 60,
        clientId: 'drop_' + Math.random().toString(16).substr(2, 8),
        clean: true,
        connectTimeout: 4000,
    });

    client.on('connect', () => {
        isConnected = true;
        updateStatus('online', 'Relay Ready');
        log('Connected to Global Relay');
        
        // Subscribe to my own inbox
        client.subscribe(`infinitydrop/${myId}/#`, (err) => {
            if(!err) log(`Listening on channel: ${myId}`);
        });
    });

    client.on('error', (err) => {
        log(`Connection Error: ${err.message}`);
        updateStatus('error', 'Error');
    });

    // --- 5. LOGIC: CONNECT ---
    function connectToPartner() {
        const input = document.getElementById('partner-id').value.trim().toUpperCase();
        if(!input) return alert("Enter Partner ID");
        if(input === myId) return alert("Cannot connect to self");

        partnerId = input;
        
        // Handshake
        publishTo(partnerId, 'signal', { type: 'hello', sender: myId });
        
        document.getElementById('btn-connect').innerText = "Requesting...";
    }

    // --- 6. LOGIC: MESSAGING ---
    client.on('message', (topic, message) => {
        // topic format: infinitydrop/{myId}/{type}
        const msgType = topic.split('/').pop(); // 'signal' or 'data'
        
        try {
            const payload = JSON.parse(message.toString());

            if (msgType === 'signal') {
                handleSignal(payload);
            } else if (msgType === 'data') {
                handleData(payload);
            }
        } catch (e) {
            console.error("Parse error", e);
        }
    });

    function publishTo(target, type, data) {
        // Publish to: infinitydrop/{targetId}/{type}
        client.publish(`infinitydrop/${target}/${type}`, JSON.stringify(data));
    }

    // --- 7. HANDLERS ---
    function handleSignal(data) {
        if(data.type === 'hello') {
            log(`Connection request from ${data.sender}`);
            partnerId = data.sender;
            document.getElementById('partner-id').value = partnerId;
            
            // Auto-accept and switch UI
            publishTo(partnerId, 'signal', { type: 'welcome', sender: myId });
            activateTransferUI();
        } 
        else if (data.type === 'welcome') {
            log(`Connected to ${data.sender}!`);
            activateTransferUI();
        }
    }

    function activateTransferUI() {
        document.getElementById('panel-connect').classList.add('hidden');
        document.getElementById('panel-transfer').classList.remove('hidden');
        updateStatus('online', 'Tunnel Established');
    }

    function handleData(data) {
        // Receiver Logic
        if(data.type === 'head') {
            log(`Incoming: ${data.name}`);
            fileRegistry[data.fid] = { 
                meta: data, 
                buffer: [], 
                received: 0,
                chunksReceived: 0
            };
            createFileUI(data.fid, data.name, data.size, '⬇');
        } 
        else if (data.type === 'chunk') {
            const f = fileRegistry[data.fid];
            if(!f) return;
            
            // Convert Base64 back to ArrayBuffer
            const binaryString = window.atob(data.data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            
            f.buffer.push(bytes.buffer);
            f.received += bytes.length;
            f.chunksReceived++;

            updateUI(data.fid, f.received, f.meta.size);
        } 
        else if (data.type === 'end') {
            const f = fileRegistry[data.fid];
            if(!f) return;
            log(`Finished: ${f.meta.name}`);
            
            const blob = new Blob(f.buffer, { type: f.meta.mime });
            const url = URL.createObjectURL(blob);
            
            const btn = document.getElementById(`btn-${data.fid}`);
            btn.style.display = 'block';
            btn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = f.meta.name;
                a.click();
            };
            delete fileRegistry[data.fid];
        }
    }

    // --- 8. SENDER LOGIC ---
    document.getElementById('file-input').addEventListener('change', async (e) => {
        for (const file of e.target.files) {
            const fid = Math.random().toString(36).substr(2, 9);
            log(`Queued: ${file.name}`);
            createFileUI(fid, file.name, file.size, '⬆');

            // 1. Send Header
            publishTo(partnerId, 'data', {
                type: 'head', fid, name: file.name, size: file.size, mime: file.type
            });

            // 2. Read & Send Chunks
            const reader = new FileReader();
            let offset = 0;

            const readSlice = (start, end) => {
                return new Promise((resolve) => {
                    const r = new FileReader();
                    r.onload = (evt) => resolve(evt.target.result);
                    r.readAsDataURL(file.slice(start, end)); // Read as Base64 directly
                });
            };

            while (offset < file.size) {
                const dataUrl = await readSlice(offset, offset + CHUNK_SIZE);
                // Remove "data:application/octet-stream;base64," prefix
                const base64Data = dataUrl.split(',')[1]; 

                publishTo(partnerId, 'data', {
                    type: 'chunk', fid, data: base64Data
                });

                offset += CHUNK_SIZE;
                updateUI(fid, Math.min(offset, file.size), file.size);
                
                // Throttle to prevent flooding the public broker (Important!)
                await new Promise(r => setTimeout(r, 20)); 
            }

            // 3. Send End
            publishTo(partnerId, 'data', { type: 'end', fid });
            log(`Sent: ${file.name}`);
        }
    });

    // --- 9. UI HELPERS ---
    function updateStatus(cls, text) {
        document.getElementById('status-dot').className = `status-dot ${cls}`;
        document.getElementById('status-text').innerText = text;
    }

    function createFileUI(fid, name, size, icon) {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                <span>${icon} ${name}</span>
                <span style="color:#666">${formatSize(size)}</span>
            </div>
            <div class="progress-bar"><div id="prog-${fid}" class="progress-fill"></div></div>
            <button id="btn-${fid}" class="btn-main" style="margin-top:10px; padding:8px; display:none; font-size:0.8rem;">Download</button>
        `;
        document.getElementById('file-queue').prepend(div);
    }

    function updateUI(fid, curr, total) {
        const pct = (curr / total) * 100;
        const el = document.getElementById(`prog-${fid}`);
        if(el) el.style.width = `${pct}%`;
    }
</script>
</body>
</html>
